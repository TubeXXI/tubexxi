services:
  proto-gen:
    build:
      context: ./tools/proto-gen
      dockerfile: Dockerfile
    container_name: tubexxi_proto_gen
    profiles: ["tools"]
    volumes:
      - ./:/workspace

  scraper:
    build:
      context: ./python-service
      dockerfile: Dockerfile
    container_name: tubexxi_python_service
    restart: unless-stopped
    ports:
      - "127.0.0.1:${SCRAPER_PORT:-50051}:${SCRAPER_PORT:-50051}"
    environment:
      SCRAPER_PORT: ${SCRAPER_PORT:-50051}
      SCRAPER_HOST: 0.0.0.0
      MOVIE_BASE_URL: ${MOVIE_BASE_URL:-https://tv8.lk21official.cc}
      SERIES_BASE_URL: ${SERIES_BASE_URL:-https://tv3.nontondrama.my}
      ANIME_BASE_URL: ${ANIME_BASE_URL:-https://otakudesu.best}
    networks:
      - tubexxi-network
      - shared-network
    healthcheck:
      test:
        [
          "CMD-SHELL",
          'python -c "import os,socket; s=socket.socket(); s.settimeout(2); s.connect((''127.0.0.1'', int(os.getenv(''SCRAPER_PORT'',''50051'')))); s.close()"',
        ]
      interval: 10s
      timeout: 5s
      retries: 10

  backend:
    build:
      context: ./go-service
      dockerfile: Dockerfile
    container_name: tubexxi_backend
    restart: unless-stopped
    ports:
      - "127.0.0.1:${APP_PORT:-5002}:${APP_PORT:-5002}"
    environment:
      APP_NAME: ${APP_NAME:-go-service}
      APP_PORT: ${APP_PORT:-5002}
      APP_ENV: ${APP_ENV:-production}
      APP_DEBUG: ${APP_DEBUG:-false}
      APP_URL: ${APP_URL:-http://localhost:5002}
      APP_CLIENT_URL: ${APP_CLIENT_URL:-http://localhost:5173}
      APP_ADMIN_EMAIL: ${APP_ADMIN_EMAIL:-premiumwatchdevice@gmail.com}

      DB_HOST: ${DB_HOST:-postgres}
      DB_PORT: ${DB_PORT:-5432}
      DB_USER: ${DB_USER:-postgres}
      DB_PASSWORD: ${DB_PASSWORD:-postgres}
      DB_NAME: ${DB_NAME:-indoxxi}
      DB_SSL_MODE: ${DB_SSL_MODE:-disable}
      DB_MAX_OPEN_CONNS: ${DB_MAX_OPEN_CONNS:-100}
      DB_MAX_IDLE_CONNS: ${DB_MAX_IDLE_CONNS:-100}
      DB_CONN_MAX_LIFETIME: ${DB_CONN_MAX_LIFETIME:-5m}
      DATABASE_URL: ${DATABASE_URL:-postgres://postgres:postgres@postgres:5432/indoxxi?sslmode=disable}

      REDIS_HOST: ${REDIS_HOST:-redis}
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      REDIS_DB: ${REDIS_DB:-0}
      REDIS_ASYNQ_DB: ${REDIS_ASYNQ_DB:-1}
      REDIS_INSTANCE: ${REDIS_INSTANCE:-default}
      REDIS_POOL_SIZE: ${REDIS_POOL_SIZE:-10}
      REDIS_CONCURRENCY: ${REDIS_CONCURRENCY:-10}

      CENTRIFUGE_URL: ${CENTRIFUGE_URL:-http://centrifugo:8000}
      CENTRIFUGO_API_KEY: ${CENTRIFUGO_API_KEY:-1234567890}
      CENTRIFUGO_TOKEN_SECRET: ${CENTRIFUGO_TOKEN_SECRET:-1234567890}

      MINIO_ENDPOINT: ${MINIO_ENDPOINT:-minio:9000}
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY:-minioadmin}
      MINIO_BUCKET: ${MINIO_BUCKET:-indoxxi}
      MINIO_USE_SSL: ${MINIO_USE_SSL:-false}

      BCRYPT_COST: ${BCRYPT_COST:-10}
      ENCRYPTION_KEY: ${ENCRYPTION_KEY:-1234567890}
      JWT_SECRET: ${JWT_SECRET:-1234567890}
      JWT_EXPIRE_HOURS: ${JWT_EXPIRE_HOURS:-15m}
      JWT_REFRESH_EXPIRE_HOURS: ${JWT_REFRESH_EXPIRE_HOURS:-24h}

      SMTP_HOST: ${SMTP_HOST:-smtp.gmail.com}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USERNAME: ${SMTP_USERNAME:-}
      SMTP_PASSWORD: ${SMTP_PASSWORD:-}
      SMTP_FROM_NAME: ${SMTP_FROM_NAME:-}
      SMTP_FROM_EMAIL: ${SMTP_FROM_EMAIL:-}

      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN:-}
      TELEGRAM_CHAT_ID: ${TELEGRAM_CHAT_ID:-}
      TELEGRAM_NOTIFICATIONS: ${TELEGRAM_NOTIFICATIONS:-false}

      SCRAPER_HOST: scraper
      SCRAPER_PORT: ${SCRAPER_PORT:-50051}

      FIREBASE_PROJECT_ID: ${FIREBASE_PROJECT_ID:-}
      SETTINGS_SCOPE_MAP: ${SETTINGS_SCOPE_MAP:-}
    volumes:
      - ./go-service/service-account.json:/app/service-account.json
      - ./go-service/logs:/app/logs
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      scraper:
        condition: service_healthy
      centrifugo:
        condition: service_started
    networks:
      - tubexxi-network
      - shared-network
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -fsS http://localhost:${APP_PORT:-5002}/health || exit 1",
        ]
      interval: 30s
      timeout: 10s
      retries: 5

  worker:
    build:
      context: ./go-service
      dockerfile: Dockerfile
    container_name: tubexxi_worker_service
    restart: unless-stopped
    command: ["./worker"]
    environment:
      APP_NAME: ${APP_NAME:-go-service}
      APP_ENV: ${APP_ENV:-production}
      APP_DEBUG: ${APP_DEBUG:-false}
      DB_HOST: ${DB_HOST:-postgres}
      DB_PORT: ${DB_PORT:-5432}
      DB_USER: ${DB_USER:-postgres}
      DB_PASSWORD: ${DB_PASSWORD:-postgres}
      DB_NAME: ${DB_NAME:-indoxxi}
      DB_SSL_MODE: ${DB_SSL_MODE:-disable}
      DB_MAX_OPEN_CONNS: ${DB_MAX_OPEN_CONNS:-100}
      DB_MAX_IDLE_CONNS: ${DB_MAX_IDLE_CONNS:-100}
      DB_CONN_MAX_LIFETIME: ${DB_CONN_MAX_LIFETIME:-5m}
      DATABASE_URL: ${DATABASE_URL:-postgres://postgres:postgres@postgres:5432/indoxxi?sslmode=disable}
      REDIS_HOST: ${REDIS_HOST:-redis}
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      REDIS_DB: ${REDIS_DB:-0}
      REDIS_ASYNQ_DB: ${REDIS_ASYNQ_DB:-1}
      REDIS_INSTANCE: ${REDIS_INSTANCE:-default}
      REDIS_POOL_SIZE: ${REDIS_POOL_SIZE:-10}
      REDIS_CONCURRENCY: ${REDIS_CONCURRENCY:-10}
      CENTRIFUGE_URL: ${CENTRIFUGE_URL:-http://centrifugo:8000}
      CENTRIFUGO_API_KEY: ${CENTRIFUGO_API_KEY:-1234567890}
      CENTRIFUGO_TOKEN_SECRET: ${CENTRIFUGO_TOKEN_SECRET:-1234567890}
      MINIO_ENDPOINT: ${MINIO_ENDPOINT:-minio:9000}
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY:-minioadmin}
      MINIO_BUCKET: ${MINIO_BUCKET:-indoxxi}
      MINIO_USE_SSL: ${MINIO_USE_SSL:-false}
      SCRAPER_HOST: scraper
      SCRAPER_PORT: ${SCRAPER_PORT:-50051}
      FIREBASE_PROJECT_ID: ${FIREBASE_PROJECT_ID:-}
    volumes:
      - ./go-service/logs:/app/logs
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      scraper:
        condition: service_healthy
    networks:
      - tubexxi-network
      - shared-network

  setup:
    build:
      context: ./go-service
      dockerfile: Dockerfile
    container_name: tubexxi_setup
    restart: "no"
    profiles: ["setup"]
    environment:
      DB_HOST: ${DB_HOST:-postgres}
      DB_PORT: ${DB_PORT:-5432}
      DB_USER: ${DB_USER:-postgres}
      DB_PASSWORD: ${DB_PASSWORD:-postgres}
      DB_NAME: ${DB_NAME:-indoxxi}
      DB_SSL_MODE: ${DB_SSL_MODE:-disable}
      DB_MAX_OPEN_CONNS: ${DB_MAX_OPEN_CONNS:-100}
      DB_MAX_IDLE_CONNS: ${DB_MAX_IDLE_CONNS:-100}
      DB_CONN_MAX_LIFETIME: ${DB_CONN_MAX_LIFETIME:-5m}
      DATABASE_URL: ${DATABASE_URL:-postgres://postgres:postgres@postgres:5432/indoxxi?sslmode=disable}
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - tubexxi-network
      - shared-network
    command: >
      /bin/sh -c "
      echo 'Waiting for PostgreSQL to be ready...';
      until pg_isready -h $${DB_HOST} -p $${DB_PORT} -U $${DB_USER} -d $${DB_NAME}; do
        echo 'Waiting for PostgreSQL...';
        sleep 2;
      done;
      echo 'Running migrations...';
      migrate -path database/migrations -database $${DATABASE_URL} up;
      echo 'Running seed...';
      ./seed;
      echo 'Setup completed!';
      "

networks:
  tubexxi-network:
    driver: bridge

  shared-network:
    external: true
    name: shared-network
